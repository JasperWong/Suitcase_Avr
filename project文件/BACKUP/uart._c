#include"uart.h"

uchar num[4];

/*********************************************************************************************
串口0初始化函数

函数说明：串口初始化函数。
晶振频率：CPU内部1M晶振。
带入参数：无
返回参数：无
*********************************************************************************************/

void uart_init(unsigned int baud)
{
   UCSR0C=0x06;             //选择UCSRC，异步模式，禁止                        
                            //   校验，1位停止位，8位数据位
   baud=8000000/16/baud-1;  //波特率最大为65K
   UBRR0L=baud; 					     	  
   UBRR0H=baud>>8; 		    //设置波特率
   //UCSR0B=(1<<TXEN0)|(1<<RXEN0); //接收、发送使能，接收中断使能
   SREG|=0x80;	            //全局中断开放
   DDRE|=0X02;	            //配置TX为输出（很重要）
}
void uart1_init(unsigned int baud)
{
   UCSR1C=0x06;             //选择UCSRC，异步模式，禁止                        
                            //   校验，1位停止位，8位数据位
   baud=8000000/16/baud-1;  //波特率最大为65K
   UBRR1L=baud; 					     	  
   UBRR1H=baud>>8; 		    //设置波特率
   UCSR1B=(1<<TXEN0)|(1<<RXEN0)|(1<<RXCIE0); //接收、发送使能，接收中断使能
   DDRD|=(1<<3);	            //配置TX为输出（很重要）
}
/*********************************************************************************************
数据发送

函数说明：数据发送，查询方式。
晶振频率：CPU内部1M晶振。
带入参数：i 发送数据，一字节。
返回参数：无
*********************************************************************************************/
void uart0_transmit(unsigned char i) {

	while (!(UCSR0A & (1<<UDRE0)));					/* 等待发送缓冲器为空			*/
	UDR0 = i;										/* 发送数据							*/
}

/*********************************************************************************************
数据发送

函数说明：数据发送，查询方式。
晶振频率：CPU内部1M晶振。
带入参数：1s内的脉冲个数
返回参数：无
串口输出: 1s内的脉冲个数   1s内转的圈数r/min  1s内转的速度m/s
*********************************************************************************************/

void sent(int number)
{
	uart0_transmit(number/1000);
	number = number%1000;
	uart0_transmit(number/100);
	number = number%100;
	uart0_transmit(number/10);
	number = number%10;
	uart0_transmit(number);
	//uart0_str("r/min:");
	//uart0_transmit(number*0.15);		//r/min
	//uart0_str("r/s:");
	//uart0_transmit(number*9/10000*pi);		//m/min
}



/*void sent(int number)
{
	num[0] = number/1000;
	number = number%1000;
	num[1] = number/100;
	number = number%100;
	num[2] = number/10;
	number = number%10;
	num[3] = number;
	uart0_str(num);

	
}*/

/*********************************************************************************************
数据发送

函数说明：数据发送，查询方式。
晶振频率：CPU内部1M晶振。
带入参数：指针，指向字符串。
返回参数：无
*********************************************************************************************/
void uart0_str(unsigned char *p) {
   unsigned char i;
	while (*p != 0x0d) 
	    {
		while (!(UCSR0A & (1<<UDRE0)));				/* 等待发送缓冲器为空			*/
		UDR0 = *p;									/* 发送数据							*/
		p ++;
		}
}

/*********************************************************************************************
数据接收

函数说明：数据接收，查询方式。
晶振频率：CPU内部1M晶振。
带入参数：无
返回参数：接收的数据1字节。
*********************************************************************************************/
unsigned char uart0_receive(void) {

	while (!(UCSR0A & (1<<RXC0)));					/* 等待接收数据					*/
	return UDR0;										/* 获取并返回数据				*/
}
